<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CLAIM TOKEN $GODMODE — Free Mint</title>
  <!-- fc:miniapp meta (required by Farcaster Mini Apps spec) -->
  <meta name="fc:miniapp" content='{"title":"CLAIM TOKEN $GODMODE FREE MINT","description":"Free-ish mint for Farcaster users — Max 50 mints per user. Base Mainnet.","action":"/","image":"/splash.png"}' />
  <style>
    /* Luxurious glassmorphism styling */
    :root{--bg:#0b0f14;--card:#0f1720;--accent:linear-gradient(90deg,#8b5cf6,#06b6d4);--glass:rgba(255,255,255,0.04)}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{background:radial-gradient(1200px 600px at 10% 10%, rgba(139,92,246,0.08), transparent), radial-gradient(800px 400px at 90% 90%, rgba(6,182,212,0.05), transparent), var(--bg);color:#e6eef8;display:flex;align-items:center;justify-content:center;padding:32px}
    .container{width:980px;max-width:95%;border-radius:20px;padding:28px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 10px 40px rgba(2,6,23,0.7);display:grid;grid-template-columns:380px 1fr;gap:24px}
    .left{border-radius:16px;padding:20px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));backdrop-filter: blur(8px);}
    .logo{height:120px;width:120px;border-radius:16px;display:block;margin:0 auto 12px;background:linear-gradient(135deg,#8b5cf6,#06b6d4);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:22px}
    h1{font-size:20px;margin:6px 0 12px;text-align:center}
    .sub{font-size:13px;color:#b7c6d9;text-align:center;margin-bottom:18px}
    .stat{display:flex;gap:10px;justify-content:space-between;padding:12px;background:var(--glass);border-radius:12px;margin-bottom:12px}
    .mint-controls{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:6px}
    button{background:var(--accent);border:0;padding:10px 14px;border-radius:12px;color:#061025;font-weight:700;cursor:pointer}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#dbeafe}
    .big{font-size:18px;padding:14px 18px}
    .right{padding:20px;border-radius:16px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));}
    .progress{height:18px;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden;margin:12px 0}
    .progress > i{display:block;height:100%;width:0;background:linear-gradient(90deg,#06b6d4,#60a5fa);transition:width 800ms ease}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:32px;background:#061025;padding:12px 16px;border-radius:10px;box-shadow:0 6px 20px rgba(2,6,23,0.6);display:none}
    .muted{opacity:0.78;font-size:13px}
    input[type=number]{width:80px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    footer{font-size:12px;color:#9fb0c9;margin-top:12px}
  </style>
</head>
<body>
  <div class="container">
    <div class="left">
      <div class="logo">GODMODE</div>
      <h1>CLAIM TOKEN $GODMODE — FREE MINT</h1>
      <div class="sub">Base Mainnet • Contract: <span id="contractAddr">0xfe0b0148A535ab66F83e19756A20A0b9fCAF1305</span></div>

      <div class="stat"><div>
        <div class="muted">Total Supply</div>
        <div>1,000,000,000</div>
      </div><div>
        <div class="muted">Max / user</div>
        <div>50</div>
      </div></div>

      <div class="stat"><div>
        <div class="muted">Tokens / mint</div>
        <div>45,000</div>
      </div><div>
        <div class="muted">Price</div>
        <div>Free Mint (0.00012 ETH fee exists) </div>
      </div></div>

      <div style="text-align:center;margin-top:8px">
        <div class="muted">Select mints</div>
        <div class="mint-controls">
          <button id="dec" class="ghost">-</button>
          <input id="count" type="number" min="1" max="50" value="1" />
          <button id="inc" class="ghost">+</button>
        </div>

        <div style="margin-top:14px">
          <button id="mintBtn" class="big">Mint</button>
          <button id="connectBtn" class="ghost">Connect Wallet</button>
        </div>
      </div>

      <div style="margin-top:18px">
        <div class="muted">Mint progress</div>
        <div class="progress"><i id="bar"></i></div>
        <div class="muted" id="progressText">0 / 20,000 mints</div>
      </div>

      <footer>Luxury UI • Built for Farcaster Mini Apps</footer>
    </div>

    <div class="right">
      <h3>How it works</h3>
      <p class="muted">This mini app lets Farcaster users mint $GODMODE from the contract on Base Mainnet. After a successful mint the app will offer to create a composer action (a cast) with an optional message and a link to your claim page.</p>

      <div style="margin-top:14px">
        <h4>Preview cast</h4>
        <textarea id="castText" rows="4" style="width:100%;border-radius:10px;padding:10px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:inherit">I just claimed $GODMODE — free mint! Try it: https://claim-token-godmode.vercel.app/</textarea>
        <div style="margin-top:10px;text-align:right"><button id="autoCast" class="ghost">Autocast after mint (toggle)</button></div>
      </div>

      <div style="margin-top:18px">
        <h4>Status</h4>
        <div id="status" class="muted">Not connected</div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
  // Single-file mini app JS — no bundler required
  (async function(){
    const CONTRACT = '0xfe0b0148A535ab66F83e19756A20A0b9fCAF1305';
    const ABI = [
      {"inputs":[{"internalType":"uint256","name":"mintCount","type":"uint256"}],"name":"mint","outputs":[],"stateMutability":"payable","type":"function"},
      {"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"remainingMintsForUser","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"remainingMints","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
    ];

    // UI elements
    const connectBtn = document.getElementById('connectBtn');
    const mintBtn = document.getElementById('mintBtn');
    const countInput = document.getElementById('count');
    const dec = document.getElementById('dec');
    const inc = document.getElementById('inc');
    const status = document.getElementById('status');
    const bar = document.getElementById('bar');
    const progressText = document.getElementById('progressText');
    const toast = document.getElementById('toast');
    const autoCastToggle = document.getElementById('autoCast');
    const castText = document.getElementById('castText');

    let provider = null;
    let signer = null;
    let ethersLib = null;
    let autocast = false;

    function showToast(t){ toast.style.display='block'; toast.textContent=t; setTimeout(()=>toast.style.display='none',3500); }

    // simple dynamic inc/dec
    dec.onclick = ()=>{ countInput.value = Math.max(1, Number(countInput.value)-1); }
    inc.onclick = ()=>{ countInput.value = Math.min(50, Number(countInput.value)+1); }

    autoCastToggle.onclick = ()=>{ autocast = !autocast; autoCastToggle.textContent = autocast? 'Autocast after mint: ON' : 'Autocast after mint (toggle)'; }

    // detect Farcaster provider or standard EIP-1193 provider
    function detectProvider(){
      if(window.farcaster && window.farcaster.request) return window.farcaster;
      if(window.ethereum && window.ethereum.request) return window.ethereum;
      // Some Farcaster clients expose sdk through parent window postMessage — fallback to walletconnect / injected
      return null;
    }

    async function autoConnectIfPossible(){
      provider = detectProvider();
      if(!provider){ status.textContent='No injected Farcaster wallet detected (open inside Farcaster/Frame)'; return; }
      try{
        // try eth_accounts first
        const accounts = await provider.request({ method: 'eth_accounts' });
        if(accounts && accounts.length){ await onConnect(accounts[0]); return; }
        // otherwise try request accounts (this will prompt if allowed by client)
        const acc = await provider.request({ method: 'eth_requestAccounts' });
        if(acc && acc.length) await onConnect(acc[0]);
      }catch(e){ console.warn('autoConnect failed',e); }
    }

    async function onConnect(address){
      // lazy-load ethers from CDN
      if(!ethersLib){
        const script = document.createElement('script');
        script.src='https://cdn.jsdelivr.net/npm/ethers@6.8.3/dist/ethers.umd.min.js';
        document.head.appendChild(script);
        await new Promise(r=>script.onload=r);
        ethersLib = window.ethers;
      }
      provider = detectProvider() || provider;
      signer = new ethersLib.BrowserProvider(provider);
      window.contract = new ethersLib.Contract(CONTRACT, ABI, await signer.getSigner());
      status.textContent = 'Connected: ' + (await signer.getAddress()).slice(0,8) + '...';
      connectBtn.style.display='none';
      showToast('Wallet connected');
      // update progress
      updateProgress();
    }

    connectBtn.onclick = async ()=>{
      try{
        provider = detectProvider();
        if(!provider) return showToast('Open this page inside Farcaster client to use the embedded wallet provider');
        const acc = await provider.request({ method: 'eth_requestAccounts' });
        if(acc && acc.length) await onConnect(acc[0]);
      }catch(e){ console.error(e); showToast('Connection failed'); }
    }

    async function updateProgress(){
      try{
        if(!window.contract) return;
        const remaining = await window.contract.remainingMints();
        const total = 20000; // from contract spec
        const minted = total - Number(remaining || 0);
        const pct = Math.min(100, Math.round((minted/total)*100));
        bar.style.width = pct + '%';
        progressText.textContent = minted + ' / ' + total + ' mints';
      }catch(e){ console.warn('progress error',e); }
    }

    mintBtn.onclick = async ()=>{
      try{
        if(!window.contract) return showToast('Connect your Farcaster wallet first');
        const count = Number(countInput.value);
        if(count < 1 || count > 50) return showToast('Invalid mint count');
        // price per mint is 0.00012 ETH
        const pricePer = 0.00012;
        const value = ethersLib.parseEther((pricePer * count).toString());
        showToast('Sending mint tx...');
        const tx = await window.contract.mint(count, { value });
        showToast('Transaction submitted, waiting for confirmation...');
        await tx.wait();
        showToast('Mint success!');
        await updateProgress();
        if(autocast){
          // ask Farcaster client to open composer with suggested cast
          try{
            // Use the mini app SDK action via postMessage (composer action)
            window.parent.postMessage({ type: 'createCast', data: { cast: { text: castText.value, embeds: ['https://claim-token-godmode.vercel.app/'] } } }, '*');
          }catch(e){ console.warn('autocast failed',e); }
        }
      }catch(err){ console.error(err); showToast('Mint failed: ' + (err.message||err)); }
    }

    // attempt auto-connect when loaded (inside Farcaster client this should usually auto-auth)
    await autoConnectIfPossible();

    // refresh progress periodically
    setInterval(updateProgress, 15000);

    // If the page is loaded outside a Farcaster frame — show a hint
    if(!detectProvider()){
      connectBtn.style.display='inline-block';
      connectBtn.textContent='Open in Farcaster to enable one-click connect';
    }

    // Expose for debugging
    window._godmode = { updateProgress };
  })();
  </script>
</body>
</html>
