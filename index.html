<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLAIM TOKEN $GODMODE FREE MINT</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Ethers.js for blockchain interaction -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.12.1/dist/ethers.umd.min.js"></script>
    <style>
        /* Custom font for a more 'luxury' feel */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap');
        .font-cinzel {
            font-family: 'Cinzel', serif;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-lg bg-gray-800 p-8 rounded-3xl shadow-[0_0_40px_rgba(252,211,77,0.3)] border border-yellow-700/50 transition-all duration-300 hover:shadow-[0_0_50px_rgba(252,211,77,0.5)]">
        
        <!-- Header -->
        <h1 class="text-4xl md:text-5xl font-extrabold text-center font-cinzel tracking-wider mb-2 bg-clip-text text-transparent bg-gradient-to-r from-yellow-300 to-yellow-500">
            $GODMODE
        </h1>
        <h2 class="text-xl md:text-2xl text-center font-semibold text-gray-300 mb-8">
            CLAIM FREE MINT
        </h2>

        <!-- Status & Progress Container -->
        <div id="mint-status-container" class="space-y-4 mb-8">
            
            <p id="wallet-address-display" class="text-center text-sm text-yellow-400/80 break-all h-5">
                <!-- Wallet status/address will be displayed here -->
            </p>

            <!-- Mint Progress Bar -->
            <div class="bg-gray-700 rounded-full h-4">
                <div id="progress-bar" class="h-4 rounded-full transition-all duration-700" style="width: 0%; background-color: #FCD34D;"></div>
            </div>
            <p id="mint-progress-text" class="text-center text-sm font-medium text-gray-400">
                Loading mint progress...
            </p>

            <div class="flex justify-between text-sm pt-2 text-gray-400">
                <p>Max Per User: <span class="text-yellow-300 font-bold">50x</span></p>
                <p>Tokens per Mint: <span class="text-yellow-300 font-bold">45,000 $GODMODE</span></p>
            </div>
        </div>

        <!-- Call to Action Button -->
        <button id="mint-button" onclick="handleMint()" class="w-full py-4 text-xl font-bold rounded-xl shadow-lg transition-all duration-300 transform bg-gradient-to-r from-yellow-500 to-yellow-600 text-gray-900 disabled:opacity-50 disabled:cursor-not-allowed hover:from-yellow-400 hover:to-yellow-500 hover:scale-[1.01] active:scale-95">
            MINT 45,000 $GODMODE (0.00012 ETH Fee)
        </button>

        <!-- Message/Error Display -->
        <p id="message-area" class="text-center mt-4 text-red-400 min-h-6"></p>

        <!-- Autocast / Share Success Button (Initially hidden) -->
        <button id="autocast-button" onclick="shareOnFarcaster()" class="hidden w-full py-3 text-lg font-bold rounded-xl mt-6 transition-all duration-300 transform bg-blue-600 text-white hover:bg-blue-700 hover:scale-[1.01] active:scale-95">
            Autocast Success on Farcaster
        </button>
    </div>

    <script>
        // --- CONSTANTS ---
        const CONTRACT_ADDRESS = "0xfe0b0148A535ab66F83e19756A20A0b9fCAF1305";
        // Base Mainnet Chain ID is 8453 (0x2105)
        const CHAIN_ID = 8453; 
        // 0.00012 ETH in Wei
        const MINT_PRICE_WEI = BigInt("120000000000000"); 
        const MINT_COUNT = 1; // Mints 45,000 tokens
        
        // Minimal ABI for the required functions
        const ABI = [
            { "inputs": [], "name": "TOTAL_MINTS_AVAILABLE", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
            { "inputs": [], "name": "totalMintCount", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "mintCount", "type": "uint256" }], "name": "mint", "outputs": [], "stateMutability": "payable", "type": "function" }
        ];

        // --- DOM Elements ---
        const mintButton = document.getElementById('mint-button');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('mint-progress-text');
        const messageArea = document.getElementById('message-area');
        const walletDisplay = document.getElementById('wallet-address-display');
        const autocastButton = document.getElementById('autocast-button');

        // --- STATE & UTILS ---
        let totalMintsAvailable = 20000;
        let provider = null;
        let signer = null;
        let contract = null;
        let userAddress = null;

        /**
         * Converts an address to a shortened, readable format.
         */
        function shortenAddress(address) {
            if (!address) return '';
            return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
        }

        /**
         * Updates the UI with current mint progress.
         */
        function updateUI(totalMinted, maxMints) {
            const percentage = (totalMinted / maxMints) * 100;
            progressBar.style.width = `${percentage.toFixed(2)}%`;
            
            progressText.textContent = `${totalMinted.toLocaleString()} / ${maxMints.toLocaleString()} Mints Completed (${percentage.toFixed(2)}%)`;
            
            if (totalMinted >= maxMints) {
                mintButton.disabled = true;
                mintButton.textContent = "MINT SOLD OUT";
                messageArea.textContent = "All GODMODE tokens have been minted!";
            } else {
                mintButton.disabled = false;
            }
        }

        /**
         * Initializes Ethers provider and loads contract state.
         */
        async function initApp() {
            try {
                // Connect to a public Base RPC endpoint for reading data
                const readProvider = new ethers.JsonRpcProvider("https://mainnet.base.org");
                const readContract = new ethers.Contract(CONTRACT_ADDRESS, ABI, readProvider);

                // Fetch total mints available from the contract
                totalMintsAvailable = Number(await readContract.TOTAL_MINTS_AVAILABLE());
                const totalMintCount = Number(await readContract.totalMintCount());

                updateUI(totalMintCount, totalMintsAvailable);

            } catch (error) {
                console.error("Error initializing app or fetching contract state:", error);
                messageArea.textContent = "Error loading contract data. Please try again.";
            }
        }

        /**
         * Handles wallet connection, network check, and mint transaction.
         */
        async function handleMint() {
            messageArea.textContent = "Connecting wallet...";
            mintButton.disabled = true;
            mintButton.textContent = "WAITING FOR WALLET...";
            
            if (!window.ethereum) {
                messageArea.textContent = "Wallet not detected. Please open this Mini App using a Farcaster-compatible wallet browser (e.g., Warpcast).";
                mintButton.disabled = false;
                mintButton.textContent = "Wallet Not Found";
                return;
            }

            try {
                // Request account connection
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // Initialize Ethers provider and signer
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();

                // Check Chain ID
                const { chainId } = await provider.getNetwork();
                if (Number(chainId) !== CHAIN_ID) {
                    messageArea.textContent = `Please switch your wallet network to Base Mainnet (Chain ID: ${CHAIN_ID}).`;
                    mintButton.disabled = false;
                    mintButton.textContent = "Switch to Base Network";
                    return;
                }
                
                walletDisplay.textContent = `Wallet Connected: ${shortenAddress(userAddress)}`;
                messageArea.textContent = "Preparing transaction...";
                mintButton.textContent = "CONFIRM MINT...";

                // Contract instance with signer for writing
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

                // --- Mint Logic ---
                const tx = await contract.mint(MINT_COUNT, {
                    value: MINT_PRICE_WEI * BigInt(MINT_COUNT),
                });

                messageArea.textContent = "Transaction sent. Waiting for confirmation...";
                mintButton.textContent = "MINTING...";

                await tx.wait(); // Wait for transaction to be mined

                // --- Success ---
                messageArea.textContent = `Mint successful! You received 45,000 $GODMODE. Transaction: ${shortenAddress(tx.hash)}`;
                
                // Re-fetch state for progress bar update
                await initApp(); 
                
                // Show Autocast Button
                mintButton.classList.add('hidden');
                autocastButton.classList.remove('hidden');

            } catch (error) {
                console.error("Minting Error:", error);
                
                let errorMessage = "An unknown error occurred.";
                // Simple error parsing for user display
                if (error.code === 4001) {
                    errorMessage = "Transaction rejected by user.";
                } else if (error.message.includes("userMintCount")) {
                    errorMessage = "Mint failed: You have reached the maximum mint limit (50x).";
                } else if (error.message.includes("total mint limit")) {
                    errorMessage = "Mint failed: Global mint limit reached.";
                } else {
                    errorMessage = "Mint failed. Check console for details. (Wallet might not have enough ETH)";
                }

                messageArea.textContent = errorMessage;
                mintButton.disabled = false;
                mintButton.textContent = "MINT FAILED - Try Again";
                walletDisplay.textContent = "Connect Wallet";
            }
        }

        /**
         * Creates and opens the Farcaster share URL for autocasting.
         */
        function shareOnFarcaster() {
            const castText = encodeURIComponent(`I just claimed my FREE MINT of 45,000 $GODMODE tokens on Base! ðŸš€\n\nIt's time for GODMODE on Farcaster!\n\n${window.location.href}`);
            const shareUrl = `https://warpcast.com/~/compose?text=${castText}`;
            
            // Open in a new window/tab for the user to confirm the cast
            window.open(shareUrl, '_blank');
        }

        // Initialize the application when the window loads
        window.onload = initApp;

    </script>
</body>
</html>
