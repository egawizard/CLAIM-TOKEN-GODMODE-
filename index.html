import React, { useState, useEffect, useCallback } from 'react';
import { AlertCircle, Coins, TrendingUp, Zap, CheckCircle, ExternalLink, RefreshCw } from 'lucide-react';

// Main Application Component
const App = () => {
    const [mounted, setMounted] = useState(false);
    const [mintCount, setMintCount] = useState(1);
    const [totalMints, setTotalMints] = useState(0);
    const [userMints, setUserMints] = useState(0);
    const [isLoading, setIsLoading] = useState(false);
    const [txHash, setTxHash] = useState('');
    const [error, setError] = useState('');

    // --- Configuration Constants ---
    const CONTRACT_ADDRESS = '0xfe0b0148A535ab66F83e19756A20A0b9fCAF1305';
    // Total supply is 1 Billion (1,000,000,000)
    // To achieve 1B supply with 20,000 global mints, each mint must yield 50,000 tokens.
    const TOTAL_MINT_SLOTS = 20000;
    const MAX_MINTS_PER_USER = 50;
    const TOKENS_PER_MINT_SLOT = 50000;
    const TOTAL_SUPPLY = 1000000000;
    
    // Small fee (0.00012 ETH) to cover gas costs, maintaining the 'FREE MINT' headline.
    const MINT_PRICE_PER_SLOT = 0.00012; 
    const NETWORK_NAME = 'Base Mainnet';
    const APP_URL = 'https://claim-token-godmode.vercel.app/';

    // Function to simulate loading user and global mint data
    const loadContractData = useCallback(async () => {
        setIsLoading(true);
        try {
            // Simulate network delay
            await new Promise(resolve => setTimeout(resolve, 800));
            // Simulate realistic data
            setTotalMints(Math.floor(Math.random() * 8000) + 1000); // 1k to 9k total mints
            setUserMints(Math.floor(Math.random() * 10)); // User has 0-9 existing mints
            setError('');
        } catch (err) {
            console.error("Failed to load data:", err);
            setError("Failed to load mint data. Try refreshing.");
        } finally {
            setIsLoading(false);
        }
    }, []);

    useEffect(() => {
        setMounted(true);
        loadContractData();
    }, [loadContractData]);

    const progressPercentage = Math.min(100, (totalMints / TOTAL_MINT_SLOTS) * 100);
    const remainingMints = Math.max(0, TOTAL_MINT_SLOTS - totalMints);
    const userRemainingMints = Math.max(0, MAX_MINTS_PER_USER - userMints);
    const tokensToReceive = mintCount * TOKENS_PER_MINT_SLOT;
    const totalCost = (mintCount * MINT_PRICE_PER_SLOT);

    // Ensure mintCount is valid
    useEffect(() => {
        const actualMax = Math.min(userRemainingMints, remainingMints);
        if (mintCount > actualMax) {
            setMintCount(Math.max(1, actualMax));
        }
    }, [mintCount, userRemainingMints, remainingMints]);

    const handleMint = async () => {
        if (isLoading || userRemainingMints === 0 || remainingMints === 0 || mintCount === 0) return;

        setIsLoading(true);
        setError('');
        setTxHash('');

        try {
            // This is where a real Farcaster Tx Frame interaction occurs. 
            // The Frame handles the wallet connection via the secure server endpoint.
            console.log(`Simulating Tx Frame interaction for ${mintCount}x...`);
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            // Simulate successful transaction on Base
            const mockTxHash = '0x' + (Math.random() * 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF).toString(16).padStart(64, '0');
            setTxHash(mockTxHash);
            
            // Update local state
            setTotalMints(prev => Math.min(TOTAL_MINT_SLOTS, prev + mintCount));
            setUserMints(prev => Math.min(MAX_MINTS_PER_USER, prev + mintCount));
            
            // --- AUTOCAST LOGIC ---
            // This message would be generated by your backend server after transaction confirmation,
            // and presented to the user as a suggested cast, or automatically posted (if using a trusted relay).
            const remaining = remainingMints - mintCount;
            const castMessage = `I just claimed ${tokensToReceive.toLocaleString()} $GODMODE tokens! ‚ö°Ô∏è\n\nFREE MINT is still live on Base!\n${remaining.toLocaleString()} slots left.\n\nClaim yours: ${APP_URL}`;
            console.log('--- AUTOCAST MESSAGE READY ---');
            console.log(castMessage);
            
        } catch (err) {
            // In a real Frame, the error comes from the wallet or server
            const errorMessage = err.message || 'Minting failed. Ensure your Farcaster wallet has enough ETH for gas.';
            setError(errorMessage);
        } finally {
            setIsLoading(false);
        }
    };

    if (!mounted) return null;

    return (
        <div className="min-h-screen bg-gradient-to-br from-gray-900 via-zinc-900 to-black text-white font-sans p-4 sm:p-8">
            {/* Animated Background Layers */}
            <div className="absolute inset-0 overflow-hidden pointer-events-none">
                <div className="absolute w-[400px] h-[400px] bg-sky-500 rounded-full filter blur-3xl opacity-10 -top-64 -left-64 animate-slow-pulse"></div>
                <div className="absolute w-[600px] h-[600px] bg-purple-500 rounded-full filter blur-3xl opacity-10 -bottom-80 -right-80 animate-slow-pulse" style={{animationDelay: '2s'}}></div>
            </div>

            {/* Custom Animation Keyframes for Luxury Feel */}
            <style jsx="true">{`
                @keyframes slow-pulse {
                    0%, 100% { transform: scale(1); opacity: 0.1; }
                    50% { transform: scale(1.1); opacity: 0.25; }
                }
                .animate-slow-pulse {
                    animation: slow-pulse 10s infinite ease-in-out;
                }
            `}</style>

            <div className="relative z-10 container mx-auto py-4 max-w-lg">
                <div className="text-center mb-8">
                    <Zap className="w-12 h-12 text-yellow-400 mx-auto mb-2 drop-shadow-lg" />
                    <h1 className="text-4xl sm:text-5xl font-extrabold mb-1 bg-gradient-to-r from-yellow-300 via-sky-400 to-indigo-500 bg-clip-text text-transparent tracking-tighter">
                        CLAIM $GODMODE
                    </h1>
                    <p className="text-xl text-sky-300 mb-2 font-light">
                        **FREE MINT** for Farcaster Users
                    </p>
                </div>

                {/* Main Card */}
                <div className="bg-zinc-800/60 backdrop-blur-xl rounded-3xl p-6 sm:p-8 border-2 border-sky-500/30 shadow-[0_0_40px_rgba(56,189,248,0.2)] mb-6 transition-all duration-500 hover:shadow-[0_0_60px_rgba(56,189,248,0.3)]">
                    
                    {/* Stats Grid */}
                    <div className="grid grid-cols-3 gap-3 mb-6">
                        <StatCard title="Total Supply" value={TOTAL_SUPPLY.toLocaleString()} Icon={Coins} />
                        <StatCard title="Tokens Per Slot" value={TOKENS_PER_MINT_SLOT.toLocaleString()} Icon={TrendingUp} />
                        <StatCard title="Max Claims/User" value={`${MAX_MINTS_PER_USER}x`} Icon={CheckCircle} />
                    </div>

                    {/* Progress Bar Section (BAR progress mint) */}
                    <div className="mb-6 border-t border-b border-zinc-700/50 pt-6 pb-4">
                        <div className="flex justify-between items-center mb-2">
                            <span className="text-sm font-semibold text-sky-300 flex items-center gap-1">
                                <RefreshCw className={`w-4 h-4 ${isLoading ? 'animate-spin' : ''}`} /> Global Mint Progress
                            </span>
                            <span className="text-sm font-bold text-white">
                                {totalMints.toLocaleString()} / {TOTAL_MINT_SLOTS.toLocaleString()} SLOTS
                            </span>
                        </div>
                        <div className="relative h-3 bg-zinc-900/70 rounded-full overflow-hidden">
                            <div 
                                className="absolute inset-y-0 left-0 bg-gradient-to-r from-sky-400 to-indigo-500 transition-all duration-700 ease-out"
                                style={{ width: `${progressPercentage}%` }}
                            >
                                <div className="absolute inset-0 bg-white/30 opacity-50"></div>
                            </div>
                        </div>
                        <div className="mt-2 text-xs text-center text-zinc-400">
                            **{remainingMints.toLocaleString()}** Mint Slots Remaining
                        </div>
                    </div>

                    {/* User Stats */}
                    <div className="bg-zinc-900/50 rounded-xl p-4 mb-6 border border-zinc-700/50">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <span className="text-sm text-sky-300">Your Farcaster Claim Status:</span>
                            </div>
                            <span className="text-lg font-bold text-yellow-400">{userMints} / {MAX_MINTS_PER_USER} claimed</span>
                        </div>
                        <div className="mt-1 text-xs text-zinc-400">
                            You have **{userRemainingMints}** remaining claims.
                        </div>
                    </div>

                    {/* Mint Controls */}
                    <div className="mb-6">
                        <label className="block text-sm font-semibold text-sky-300 mb-3">
                            Select Quantity (Max {userRemainingMints}x)
                        </label>
                        <div className="grid grid-cols-5 gap-2 mb-4">
                            {[1, 5, 10, 25, 50].map((amount) => (
                                <button
                                    key={amount}
                                    onClick={() => setMintCount(amount)}
                                    disabled={amount > userRemainingMints || amount > remainingMints}
                                    className={`py-2 rounded-lg font-semibold text-sm transition-all shadow-md ${
                                        mintCount === amount
                                            ? 'bg-gradient-to-r from-sky-500 to-indigo-500 text-white ring-2 ring-sky-300/50 scale-105'
                                            : amount > userRemainingMints || amount > remainingMints
                                            ? 'bg-zinc-700/50 text-zinc-500 cursor-not-allowed'
                                            : 'bg-zinc-800 text-white hover:bg-zinc-700/70 border border-zinc-700'
                                    }`}
                                >
                                    {amount}x
                                </button>
                            ))}
                        </div>

                        {/* Mint Summary */}
                        <div className="bg-zinc-900/50 rounded-xl p-4 border border-indigo-500/50 mt-4">
                            <SummaryRow label="Tokens to Receive" value={`${tokensToReceive.toLocaleString()} $GODMODE`} color="text-sky-400" />
                            <SummaryRow label="Transaction Cost (Gas Fee)" value={`${totalCost.toFixed(6)} ETH`} color="text-green-400" isFee={true} />
                            <p className="text-xs text-center text-zinc-400 mt-2 italic">
                                Total cost is the minimal **Base Mainnet gas fee**. The token itself is a **FREE MINT**.
                            </p>
                        </div>
                    </div>

                    {/* Mint Button */}
                    <button
                        onClick={handleMint}
                        disabled={isLoading || userRemainingMints === 0 || remainingMints === 0 || mintCount === 0}
                        className="w-full py-4 rounded-xl font-bold text-lg transition-all duration-300 disabled:opacity-40 disabled:cursor-not-allowed bg-gradient-to-r from-sky-600 to-indigo-600 hover:from-sky-500 hover:to-indigo-500 shadow-2xl shadow-sky-900/50 hover:shadow-sky-800/80 flex items-center justify-center gap-3 transform hover:scale-[1.01]"
                    >
                        {isLoading ? (
                            <>
                                <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                                Processing Mint via Farcaster...
                            </>
                        ) : userRemainingMints === 0 ? (
                            'MAX MINT LIMIT REACHED'
                        ) : remainingMints === 0 ? (
                            'ALL SLOTS CLAIMED'
                        ) : (
                            <>
                                <Zap className="w-6 h-6 animate-pulse" />
                                EXECUTE FREE MINT ({mintCount}x)
                            </>
                        )}
                    </button>

                    {/* Transaction/Error Messages */}
                    {txHash && (
                        <MessageCard 
                            type="success" 
                            title="Mint Successful! üéâ" 
                            message={`You successfully claimed ${tokensToReceive.toLocaleString()} $GODMODE. The tokens will arrive shortly. Check the console for your Autocast message!`}
                            txHash={txHash}
                        />
                    )}
                    {error && (
                        <MessageCard 
                            type="error" 
                            title="Claim Failed" 
                            message={error}
                        />
                    )}

                </div>
                
                {/* Info Section */}
                <div className="mt-8 bg-zinc-800/60 p-6 rounded-2xl border border-zinc-700/50">
                    <h3 className="font-bold text-xl mb-3 flex items-center gap-2 text-sky-400">
                        <TrendingUp className="w-5 h-5" /> Token Details
                    </h3>
                    <TokenInfoRow label="Network" value={NETWORK_NAME} />
                    <TokenInfoRow label="Symbol" value="$GODMODE" />
                    <TokenInfoRow label="Total Supply" value={TOTAL_SUPPLY.toLocaleString()} />
                    <TokenInfoRow label="Contract" value={`${CONTRACT_ADDRESS.slice(0, 6)}...${CONTRACT_ADDRESS.slice(-4)}`} 
                        link={`https://basescan.org/address/${CONTRACT_ADDRESS}`} />
                </div>

                {/* Footer */}
                <div className="mt-8 text-center text-sm text-zinc-500">
                    <p>Optimized for Farcaster Wallets on {NETWORK_NAME}</p>
                    <p className='text-xs mt-1'>Please note: This page is the full web experience after interacting with the Farcaster Frame.</p>
                </div>
            </div>
        </div>
    );
};

// Helper Components
const StatCard = ({ title, value, Icon }) => (
    <div className="bg-zinc-700/40 rounded-xl p-3 border border-zinc-600/50 text-center hover:bg-zinc-700/60 transition duration-200">
        <Icon className="w-5 h-5 text-sky-400 mx-auto mb-1" />
        <div className="text-sm text-zinc-300 font-medium mb-0.5">{title}</div>
        <div className="text-base sm:text-lg font-extrabold text-white leading-tight">{value}</div>
    </div>
);

const SummaryRow = ({ label, value, color, isFee = false }) => (
    <div className="flex justify-between items-center py-1">
        <span className={`text-sm ${isFee ? 'text-zinc-400' : 'text-zinc-200'}`}>{label}:</span>
        <span className={`text-base font-bold ${color}`}>
            {value}
        </span>
    </div>
);

const TokenInfoRow = ({ label, value, link }) => (
    <div className="flex justify-between items-center py-1 border-b border-zinc-700/30 last:border-b-0">
        <span className="text-sm text-zinc-400">{label}:</span>
        {link ? (
            <a 
                href={link} 
                target="_blank" 
                rel="noopener noreferrer"
                className="text-sky-400 hover:text-sky-300 font-mono text-xs flex items-center gap-1 transition-colors"
            >
                {value}
                <ExternalLink className="w-3 h-3 flex-shrink-0" />
            </a>
        ) : (
            <span className="font-semibold text-sm text-white">{value}</span>
        )}
    </div>
);

const MessageCard = ({ type, title, message, txHash }) => {
    const isSuccess = type === 'success';
    const color = isSuccess ? 'green' : 'red';
    const Icon = isSuccess ? CheckCircle : AlertCircle;

    return (
        <div className={`mt-4 p-4 bg-${color}-900/30 border border-${color}-500/30 rounded-xl`}>
            <div className="flex items-start gap-3">
                <Icon className={`w-5 h-5 text-${color}-400 flex-shrink-0 mt-0.5`} />
                <div className="flex-1">
                    <p className={`text-sm font-semibold text-${color}-400 mb-1`}>
                        {title}
                    </p>
                    <p className="text-xs text-zinc-300 mb-2">
                        {message}
                    </p>
                    {txHash && (
                        <a
                            href={`https://basescan.org/tx/${txHash}`}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="inline-flex items-center gap-1 text-xs text-sky-300 hover:text-sky-200"
                        >
                            View Transaction on BaseScan
                            <ExternalLink className="w-3 h-3" />
                        </a>
                    )}
                </div>
            </div>
        </div>
    );
};

export default App;
